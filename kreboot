#!/bin/sh

set -e
[ -n "$BASH" ] && set -o pipefail

# Check that all programs we need are available, exit if not
# (relying on 'set -e' and hash returning non-zero for errors)
hash grubby kexec systemctl

target=$1
if [ -z "$target" ]; then
	if ! target=$(grubby --default-kernel); then
		# grubby prints error to stdout
		echo "grubby: $target" 1>&2
		exit 1
	fi
fi

if ! info=$(grubby --info=$target); then
	# grubby prints error to stdout
	echo "grubby: $info" 1>&2
	exit 1
fi
eval $(echo "$info" | sed "s|^\(\S*\)=\([^'\"].*\)$|\1='\2'|")

echo Boot "$title"?
read
kexec -l "$kernel" --initrd="$initrd" --command-line="root=$root $args"
systemctl kexec
